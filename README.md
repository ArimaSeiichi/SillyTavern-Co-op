# SillyTavern 联机插件 (Co-op)

仰仗Gemini2.5Pro完成的SillyTavern扩展，用于实现真正的实时、房主-客户端模式的多人联机体验。

本解决方案包含两部分：SillyTavern插件本体，以及一个专用的、负责管理连接和消息转发的WebSocket服务器。

## 功能特性

- **房主-客户端架构**: 由一名指定的“房主”管理与AI的交互，而“客户端”则将他们的输入提交给房主。
- **变量隔离**: 只有房主的电脑会处理角色卡变量（例如来自前端卡的情绪、数值等）。客户端只发送和接收纯文本，确保数据一致性并防止冲突。
- **可靠的消息拦截**: 能有效拦截用户的输入，包括来自复杂前端卡的输入。
- **现代化UI**: 屏幕上一个时尚、简约的圆形小部件会显示连接状态。它可以展开成一个功能完整的联机大厅界面。
- **集成化配置**: 所有设置都在SillyTavern原生的“扩展”设置菜单中进行管理，无需编辑独立的配置文件。
- **包含后端服务器**: 提供了一个开箱即用的Node.js WebSocket服务器。

## 安装步骤

您需要安装WebSocket服务器和SillyTavern插件两部分。

### 1. 服务器安装与设置

服务器是一个Node.js应用，需要在运行它的机器上预先安装Node.js。

1.  **复制服务器文件**: 将 `coop_server` 文件夹复制到您的服务器上。
2.  **安装依赖**: 在 `coop_server` 文件夹中打开一个终端，并运行：
    ```bash
    npm install
    ```
3.  **运行服务器**: 启动服务器：
    ```bash
    node server.js
    ```
    默认情况下，服务器将在 `8080` 端口上运行。

#### 在后台运行 (Linux)

为了让服务器在Linux机器上静默地后台运行，您可以使用 `pm2`：

```bash
# 全局安装 pm2
npm install -g pm2

# 使用 pm2 启动服务器
pm2 start server.js --name coop-server
```

### 2. 插件安装

1.  **复制插件文件夹**: 复制整个 `SillyTavern-Coop` 文件夹。
2.  **粘贴到SillyTavern中**: 将该文件夹粘贴到您SillyTavern安装目录下的 `public/extensions/` 文件夹内。
3.  **重启SillyTavern**: 停止并重新启动您的SillyTavern服务器。

重启后，插件便会生效。

## 如何使用

### 1. 配置插件

1.  在SillyTavern中，进入 **扩展菜单** (拼图图标)。
2.  在设置列表中找到 **Co-op Mode**。
3.  **联机服务器URL (Co-op Server URL)**: 输入您正在运行的服务器的WebSocket地址 (例如, `ws://your_server_ip:8080`)。
4.  **默认昵称 (Default Nickname)**: 设置一个您希望显示给其他用户的名称。
5.  保存设置。

### 2. 开始联机

一个圆形的小部件会出现在您屏幕的右下角。

-   **作为房主**: 成为**第一个**连接到服务器的人。服务器会自动将第一个连接的用户指定为房主。
-   **作为客户端加入**: 在房主已经在线后，再连接到服务器。

### 3. 游戏流程

1.  **房主**在展开的联机大厅中点击 **“请求输入” (Request Inputs)** 按钮。所有玩家的状态会变为“等待中”。
2.  **客户端**在他们自己的SillyTavern输入框中输入想要的动作/对话，然后按回车。他们的输入会被插件拦截并发送给房主，而不是直接发送给AI。
3.  **房主**也以同样的方式提交自己的输入。
4.  房主可以看到哪些人已经提交了输入。当收集齐所有输入后，**房主**点击 **“发送给AI” (Send to AI)** 按钮。
5.  所有收集到的输入会被合并，然后在房主的电脑上发送给AI。
6.  AI生成回应后，**房主的插件会自动将AI的消息广播**给所有客户端。
7.  客户端会在他们的聊天界面中看到AI的回应出现，然后重复此循环。
